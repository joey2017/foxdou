<?php
namespace App\Passport\Controller;

use App\Common\Model\AutoGenerated\user_safe_question;
use App\Common\Model\User\OperationLog;
use App\Passport\Model\SafeInspect;
use App\Passport\Service\IpService;
use Psr\Log\LoggerInterface;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\Routing\Annotation\Route;

class HomeController extends PassportBaseController {

    /**
     * 首页
     * @Route("/", name="passport_home_index")
     */
    public function indexAction(LoggerInterface $logger) {
        $login_log        = $this->getLastLogin();
        $common_questions = (new QuestionController($logger))->commonQuestionsAction(false);
        $questions        = (new user_safe_question())->all(['user_id' => $this->getPassportUser()->id]);
        $data = ['login_log' => $login_log ?: false, 'common_questions' => $common_questions, 'questions' => $questions];
        return $this->render("/Passport/Home/index.twig", $data);
    }

    /**
     * ip查询
     * @Route("/ip-query", name="passport_home_ip_query")
     */
    public function ipQueryAction(Request $request, IpService $ipService) {
        if ($request->getMethod() !== Request::METHOD_POST) {
            return $this->redirectToRoute('passport_home_index');
        }

        $login_log = $this->getLastLogin();

        if (empty($login_log['ip'])) {
            return ['status' => false];
        }
        return $ipService->query_ip_address($login_log['ip']);
    }

    /*
     * 上次登录
     */
    protected function getLastLogin() {
        $login_log = OperationLog::all(['user_id' => $this->getPassportUser()->id], ['limit' => 2]);

        if (empty($login_log)) {
            return false;
        }
        $login_log = count($login_log) >= 2 ? $login_log[1] : $login_log[0];

        return $login_log;
    }

    /**
     * 安全检测
     * @Route("/safe-inspect", name="passport_home_safe_inspect")
     */
    public function safeInspectAction() {
        return $this->renderView('/Passport/Home/safe_inspect.twig', SafeInspect::safeInspetList($this->getPassportUser()));
    }
}
